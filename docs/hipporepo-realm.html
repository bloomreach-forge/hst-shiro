<!DOCTYPE html>
    <!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-11-09 
 | Rendered using BloomReach Forge Maven Skin 3.0.1 based on Apache Maven Fluido Skin
-->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                  <meta name="Date-Revision-yyyymmdd" content="20181109" />
              <meta http-equiv="Content-Language" content="en" />
      <title>HST - Apache Shiro Integration Support Documentation &#x2013; Detail on HippoRepositoryRealm</title>
  <link rel="stylesheet" href="./css/forge-maven-skin-syntaxhighlighter-3.0.1.min.css"/>
  <link rel="stylesheet" href="./css/forge-maven-skin-3.0.1.min.css"/>
  <link rel="stylesheet" href="./css/site.css" />
  <link rel="stylesheet" href="./css/print.css" media="print" />
  <link rel="icon" type="image/png" href="./images/skin/logo_64.png" sizes="64x64">

  
  <script type="text/javascript" src="./js/forge-maven-skin-syntaxhighlighter-3.0.1.min.js"></script>
  <script type="text/javascript" src="./js/forge-maven-skin-3.0.1.min.js"></script>

    </head>
<body class="topBarDisabled">
                        <a href="https://github.com/bloomreach-forge/hst-shiro">
    <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
         src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
         alt="Fork me on GitHub">
  </a>
          <div class="container-fluid">
  <div id="banner">
    <div id="logo">
      <a href="http://www.github.com/bloomreach-forge">
        <img src="./images/skin/logo.png" alt="BloomReach Forge Logo" />
      </a>
    </div>
    <div class="pull-left">              <div id="bannerLeft">    <h1>HST-Apache Shiro Integration Support</h1>
    </div>
              </div>
    <div class="pull-right"></div>
    <div class="clear"><hr/></div>
  </div>

  <div id="breadcrumbs">
    <div class="links">
      <a href="https://developers.bloomreach.com">developers.bloomreach.com</a>
      <a href="https://www.onehippo.org">onehippo.org</a>
    </div>
    <ul class="breadcrumb">
    
  <li id="publishDate">published: 2018-11-09  
  </li>
  
        
            </ul>
    <div class="clear"><hr/></div>
  </div>
<div class="row-fluid">
  <div id="leftColumn" class="span2">
    <div class="well sidebar-nav">
    
    <ul class="nav nav-list">
            <li class="nav-header">Home</li>
              <li>  <a href="index.html" title="Home">  <span class="none"></span>  Home</a>  </li>
        <li>  <a href="release-notes.html" title="Release Notes">  <span class="none"></span>  Release Notes</a>  </li>
                  <li class="nav-header">Usage</li>
              <li>  <a href="install.html" title="Installation">  <span class="none"></span>  Installation</a>  </li>
        <li>  <a href="configuration.html" title="Configuration">  <span class="none"></span>  Configuration</a>  </li>
        <li class="active">  <a href="#"><span class="none"></span>Detail on HippoRepositoryRealm</a>
  </li>
                  <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                          <li>  <a href="project-info.html" title="Project Information">  <span class="icon-chevron-right"></span>  Project Information</a>  </li>
                                                                      <li>  <a href="project-reports.html" title="Project Reports">  <span class="icon-chevron-right"></span>  Project Reports</a>  </li>
        </ul>
    
          <hr />
      <div id="poweredBy">
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
              <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">  <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />  </a>
          </div>
    </div>
  </div>
  <div id="bodyColumn"  class="span10" >
    
  

    <div class="section">
<h2><a name="Detail_on_HippoRepositoryRealm"></a>Detail on HippoRepositoryRealm</h2>

      
<div class="section">
<h3><a name="Introduction"></a>Introduction</h3>
        
<p>
          This page will explain (a) how <tt>HippoRepositoryRealm</tt> authenticates a user against Hippo Repository security data store,
          (b) how it finds roles and (c) how it assigns permissions for the authenticated user.
        </p>
        
<p>
          Also see <a href="apidocs/org/onehippo/forge/security/support/shiro/realm/HippoRepositoryRealm.html">Javadoc of HippoRepositoryRealm</a> for details or customizations.
        </p>
      </div>

      
<div class="section">
<h3><a name="How_to_authenticate_a_user"></a>How to authenticate a user?</h3>
        
<p>
          It is really simple!
          <tt>HippoRepositoryRealm</tt> simply tries to invoke on <tt>javax.jcr.Repository#login(Credentials)</tt>
          by converting <tt>UsernamePasswordToken</tt> instance to <tt>SimpleCredentials</tt> instance.
        </p>
        
<p>
          If the login is sucessful, then the user should be authenticated. Otherwise, the authentication should fail.
        </p>
        
<p>
          See <a href="apidocs/org/onehippo/forge/security/support/shiro/realm/HippoRepositoryRealm.html#doGetAuthenticationInfo-org.apache.shiro.authc.AuthenticationToken-">#doGetAuthenticationInfo(org.apache.shiro.authc.AuthenticationToken)</a> for detail.
        </p>
      </div>

      
<div class="section">
<h3><a name="How_to_assign_roles_to_an_authenticated_user"></a>How to assign roles to an authenticated user?</h3>
        
<p>
          This one is also very simple!
          <tt>HippoRepositoryRealm</tt> simply executes the following JCR query by default to find all the assigned group names:
        </p>
        
<div class="brush: plain">
        
<div class="source"><pre>
//element(*, hipposys:group)[(@hipposys:members = '${username}' or @hipposys:members = '*')
and @hipposys:securityprovider = 'internal'];
        </pre></div>
        </div>
        
<p>
          <i><b>Note: </b></i> the ${username} is replaced by the real username extracted from <tt>UsernamePasswordToken</tt> instance.
        </p>
      </div>

      
<div class="section">
<h3><a name="How_to_assign_permissions_to_an_authenticated_user"></a>How to assign permissions to an authenticated user?</h3>
        
<p>
          It is a bit more complex than the previous ones.
          Basically, <tt>HippoRepositoryRealm</tt> executes a JCR query like the following example
          to find all the <tt>hipposys:authrole</tt> nodes under <tt>/hippo:configuration/hippo:domains</tt>.
        </p>
        
<div class="brush: plain">
        
<div class="source"><pre>
//hippo:configuration/hippo:domains//element(*, hipposys:authrole)
[ @hipposys:users = '${username}' or @hipposys:groups = 'author' or @hipposys:groups = 'editor' ... ]
        </pre></div>
        </div>
        
<p>
          <i><b>Note: </b></i> the ${username} is replaced by the real username extracted from <tt>UsernamePasswordToken</tt> instance,
          and the parts after 'or @hipposys:groups = ' are appended at runtime based on all the role names which were found in the previous step.
          So, for example, if the username is 'jdoe' and the user is in both 'author' and 'editor' groups,
          then the JCR query to execute should be like the following:
        </p>
        
<div class="brush: plain">
        
<div class="source"><pre>
//hippo:configuration/hippo:domains//element(*, hipposys:authrole)
[ @hipposys:users = 'jdoe' or @hipposys:groups = 'author' or @hipposys:groups = 'editor' ]
        </pre></div>
        </div>
        
<p>
          Next, in each <tt>hipposys:authrole</tt> node under a domain node (e.g, 'everywhere', 'hippodocuments', etc. under /hippo:configuration/hippo:domains/),
          <tt>HippoRepositoryRealm</tt> reads <tt>hipposys:role</tt> property.
        </p>
        
<p>
          A permission will be a <b>concatenation</b> of the <b>domain node name</b>, <b>':'</b>, and <b><tt>hipposys:role</tt> property value</b> by default.
        </p>
        
<p>
          For example, suppose the JCR query above resulted in:
        </p>
        
<ul>
          
<li>
            /hippo:configuration/hippo:domains/workflow/hippo:authrole
            <br />
            &#160;&#160;- hipposys:role = &quot;readonly&quot;
          </li>
          
<li>
            /hippo:configuration/hippo:domains/hippodocuments/hippo:authrole
            <br />
            &#160;&#160;- hipposys:role = &quot;editor&quot;
          </li>
          
<li>
            /hippo:configuration/hippo:domains/everywhere/hippo:authrole
            <br />
            &#160;&#160;- hipposys:role = &quot;admin&quot;
          </li>
        </ul>
        
<p>
          Then, the end result of permissions in <tt>HippoRepositoryRealm</tt> will be like the following set:
        </p>
        
<div class="brush: javascript">
        
<div class="source"><pre>
[ &quot;workflow:readonly&quot;, &quot;hippodocuments:editor&quot;, &quot;everywhere:admin&quot; ]
        </pre></div>
        </div>
        
<p>
          <b><i>Note: </i></b> Please see <a class="externalLink" href="http://shiro.apache.org/permissions.html">Understanding Permissions in Apache Shiro</a>
          for detail on how the permission strings work.
        </p>
      </div>

    </div>

  

    </div>
    </div>
    </div>
    <hr/>
    <footer>
    <div class="container-fluid">
      <div class="row-fluid">
          <p class="copyright">Copyright &copy;      2018.
  BloomReach Inc. All rights reserved.
</p>
    </div>
            </div>
  </footer>
    </body>
</html>

